!function(factory){"use strict";"function"==typeof define&&define.amd?define(["jquery","jquery-ui/sortable"],factory):factory(window.jQuery)}(function($){"use strict";function isOverAxis(x,reference,size){return x>reference&&x<reference+size}$.widget("mjs.nestedSortable",$.extend({},$.ui.sortable.prototype,{options:{disableParentChange:!1,doNotClear:!1,expandOnHover:700,isAllowed:function(){return!0},isTree:!1,listType:"ol",maxLevels:0,protectRoot:!1,rootID:null,rtl:!1,startCollapsed:!1,tabSize:20,branchClass:"mjs-nestedSortable-branch",collapsedClass:"mjs-nestedSortable-collapsed",disableNestingClass:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",expandedClass:"mjs-nestedSortable-expanded",hoveringClass:"mjs-nestedSortable-hovering",leafClass:"mjs-nestedSortable-leaf",disabledClass:"mjs-nestedSortable-disabled"},_create:function(){var self=this;if(this.element.data("ui-sortable",this.element.data("mjs-nestedSortable")),!this.element.is(this.options.listType))throw"nestedSortable: Please check that the listType option is set to your actual list type",new Error("nestedSortable: Please check that the listType option is set to your actual list type");this.options.isTree&&this.options.expandOnHover&&(this.options.tolerance="intersect"),$.ui.sortable.prototype._create.apply(this,arguments),this.options.isTree&&$(this.items).each(function(){var $li=this.item,hasCollapsedClass=$li.hasClass(self.options.collapsedClass),hasExpandedClass=$li.hasClass(self.options.expandedClass);$li.children(self.options.listType).length?($li.addClass(self.options.branchClass),hasCollapsedClass||hasExpandedClass||(self.options.startCollapsed?$li.addClass(self.options.collapsedClass):$li.addClass(self.options.expandedClass))):$li.addClass(self.options.leafClass)})},_destroy:function(){return this.element.removeData("mjs-nestedSortable").removeData("ui-sortable"),$.ui.sortable.prototype._destroy.apply(this,arguments)},_mouseDrag:function(event){var i,item,itemElement,intersection,previousTopOffset,parentItem,level,childLevels,itemAfter,itemBefore,newList,method,a,previousItem,nextItem,helperIsNotSibling,self=this,o=this.options,scrolled=!1,$document=$(document);for(this.position=this._generatePosition(event),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll&&(this.scrollParent[0]!==document&&"HTML"!==this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-event.pageY<o.scrollSensitivity?(scrolled=this.scrollParent.scrollTop()+o.scrollSpeed,this.scrollParent.scrollTop(scrolled)):event.pageY-this.overflowOffset.top<o.scrollSensitivity&&(scrolled=this.scrollParent.scrollTop()-o.scrollSpeed,this.scrollParent.scrollTop(scrolled)),this.overflowOffset.left+this.scrollParent[0].offsetWidth-event.pageX<o.scrollSensitivity?(scrolled=this.scrollParent.scrollLeft()+o.scrollSpeed,this.scrollParent.scrollLeft(scrolled)):event.pageX-this.overflowOffset.left<o.scrollSensitivity&&(scrolled=this.scrollParent.scrollLeft()-o.scrollSpeed,this.scrollParent.scrollLeft(scrolled))):(event.pageY-$document.scrollTop()<o.scrollSensitivity?(scrolled=$document.scrollTop()-o.scrollSpeed,$document.scrollTop(scrolled)):$(window).height()-(event.pageY-$document.scrollTop())<o.scrollSensitivity&&(scrolled=$document.scrollTop()+o.scrollSpeed,$document.scrollTop(scrolled)),event.pageX-$document.scrollLeft()<o.scrollSensitivity?(scrolled=$document.scrollLeft()-o.scrollSpeed,$document.scrollLeft(scrolled)):$(window).width()-(event.pageX-$document.scrollLeft())<o.scrollSensitivity&&(scrolled=$document.scrollLeft()+o.scrollSpeed,$document.scrollLeft(scrolled))),!1!==scrolled&&$.ui.ddmanager&&!o.dropBehaviour&&$.ui.ddmanager.prepareOffsets(this,event)),this.positionAbs=this._convertPositionTo("absolute"),previousTopOffset=this.placeholder.offset().top,this.options.axis&&"y"===this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"===this.options.axis||(this.helper[0].style.top=this.position.top+"px"),this.hovering=this.hovering?this.hovering:null,this.mouseentered=!!this.mouseentered&&this.mouseentered,function(){var _parentItem=this.placeholder.parent().parent();_parentItem&&_parentItem.closest(".ui-sortable").length&&(parentItem=_parentItem)}.call(this),level=this._getLevel(this.placeholder),childLevels=this._getChildLevels(this.helper),newList=document.createElement(o.listType),i=this.items.length-1;i>=0;i--)if(item=this.items[i],itemElement=item.item[0],(intersection=this._intersectsWithPointer(item))&&item.instance===this.currentContainer){if(-1!==itemElement.className.indexOf(o.disabledClass))if(2===intersection){if((itemAfter=this.items[i+1])&&itemAfter.item.hasClass(o.disabledClass))continue}else if(1===intersection&&(itemBefore=this.items[i-1])&&itemBefore.item.hasClass(o.disabledClass))continue;if(method=1===intersection?"next":"prev",!(itemElement===this.currentItem[0]||this.placeholder[method]()[0]===itemElement||$.contains(this.placeholder[0],itemElement)||"semi-dynamic"===this.options.type&&$.contains(this.element[0],itemElement))){if(this.mouseentered||($(itemElement).mouseenter(),this.mouseentered=!0),o.isTree&&$(itemElement).hasClass(o.collapsedClass)&&o.expandOnHover&&(this.hovering||($(itemElement).addClass(o.hoveringClass),this.hovering=window.setTimeout(function(){$(itemElement).removeClass(o.collapsedClass).addClass(o.expandedClass),self.refreshPositions(),self._trigger("expand",event,self._uiHash())},o.expandOnHover))),this.direction=1===intersection?"down":"up","pointer"!==this.options.tolerance&&!this._intersectsWithSides(item))break;$(itemElement).mouseleave(),this.mouseentered=!1,$(itemElement).removeClass(o.hoveringClass),this.hovering&&window.clearTimeout(this.hovering),this.hovering=null,!o.protectRoot||this.currentItem[0].parentNode===this.element[0]&&itemElement.parentNode!==this.element[0]?o.protectRoot||this._rearrange(event,item):this.currentItem[0].parentNode!==this.element[0]&&itemElement.parentNode===this.element[0]?($(itemElement).children(o.listType).length||(itemElement.appendChild(newList),o.isTree&&$(itemElement).removeClass(o.leafClass).addClass(o.branchClass+" "+o.expandedClass)),void 0!==(a="down"===this.direction?$(itemElement).prev().children(o.listType):$(itemElement).children(o.listType))[0]&&this._rearrange(event,null,a)):this._rearrange(event,item),this._clearEmpty(itemElement),this._trigger("change",event,this._uiHash());break}}if(function(){var _previousItem=this.placeholder.prev();previousItem=_previousItem.length?_previousItem:null}.call(this),null!=previousItem)for(;"li"!==previousItem[0].nodeName.toLowerCase()||-1!==previousItem[0].className.indexOf(o.disabledClass)||previousItem[0]===this.currentItem[0]||previousItem[0]===this.helper[0];){if(!previousItem[0].previousSibling){previousItem=null;break}previousItem=$(previousItem[0].previousSibling)}if(function(){var _nextItem=this.placeholder.next();nextItem=_nextItem.length?_nextItem:null}.call(this),null!=nextItem)for(;"li"!==nextItem[0].nodeName.toLowerCase()||-1!==nextItem[0].className.indexOf(o.disabledClass)||nextItem[0]===this.currentItem[0]||nextItem[0]===this.helper[0];){if(!nextItem[0].nextSibling){nextItem=null;break}nextItem=$(nextItem[0].nextSibling)}return this.beyondMaxLevels=0,null==parentItem||null!=nextItem||o.protectRoot&&parentItem[0].parentNode==this.element[0]||!(o.rtl&&this.positionAbs.left+this.helper.outerWidth()>parentItem.offset().left+parentItem.outerWidth()||!o.rtl&&this.positionAbs.left<parentItem.offset().left)?null==previousItem||previousItem.hasClass(o.disableNestingClass)||!(previousItem.children(o.listType).length&&previousItem.children(o.listType).is(":visible")||!previousItem.children(o.listType).length)||o.protectRoot&&this.currentItem[0].parentNode===this.element[0]||!(o.rtl&&this.positionAbs.left+this.helper.outerWidth()<previousItem.offset().left+previousItem.outerWidth()-o.tabSize||!o.rtl&&this.positionAbs.left>previousItem.offset().left+o.tabSize)?this._isAllowed(parentItem,level,level+childLevels):(this._isAllowed(previousItem,level,level+childLevels+1),previousItem.children(o.listType).length||(previousItem[0].appendChild(newList),o.isTree&&previousItem.removeClass(o.leafClass).addClass(o.branchClass+" "+o.expandedClass)),previousTopOffset&&previousTopOffset<=previousItem.offset().top?previousItem.children(o.listType).prepend(this.placeholder):previousItem.children(o.listType)[0].appendChild(this.placeholder[0]),void 0!==parentItem&&this._clearEmpty(parentItem[0]),this._trigger("change",event,this._uiHash())):(parentItem.after(this.placeholder[0]),helperIsNotSibling=!parentItem.children(o.listItem).children("li:visible:not(.ui-sortable-helper)").length,o.isTree&&helperIsNotSibling&&parentItem.removeClass(this.options.branchClass+" "+this.options.expandedClass).addClass(this.options.leafClass),void 0!==parentItem&&this._clearEmpty(parentItem[0]),this._trigger("change",event,this._uiHash())),this._contactContainers(event),$.ui.ddmanager&&$.ui.ddmanager.drag(this,event),this._trigger("sort",event,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(event){this.beyondMaxLevels&&(this.placeholder.removeClass(this.options.errorClass),this.domPosition.prev?$(this.domPosition.prev).after(this.placeholder):$(this.domPosition.parent).prepend(this.placeholder),this._trigger("revert",event,this._uiHash())),$("."+this.options.hoveringClass).mouseleave().removeClass(this.options.hoveringClass),this.mouseentered=!1,this.hovering&&window.clearTimeout(this.hovering),this.hovering=null,this._relocate_event=event,this._pid_current=$(this.domPosition.parent).parent().attr("id"),this._sort_current=this.domPosition.prev?$(this.domPosition.prev).next().index():0,$.ui.sortable.prototype._mouseStop.apply(this,arguments)},_intersectsWithSides:function(item){var half=this.options.isTree?.8:.5,isOverBottomHalf=isOverAxis(this.positionAbs.top+this.offset.click.top,item.top+item.height*half,item.height),isOverTopHalf=isOverAxis(this.positionAbs.top+this.offset.click.top,item.top-item.height*half,item.height),isOverRightHalf=isOverAxis(this.positionAbs.left+this.offset.click.left,item.left+item.width/2,item.width),verticalDirection=this._getDragVerticalDirection(),horizontalDirection=this._getDragHorizontalDirection();return this.floating&&horizontalDirection?"right"===horizontalDirection&&isOverRightHalf||"left"===horizontalDirection&&!isOverRightHalf:verticalDirection&&("down"===verticalDirection&&isOverBottomHalf||"up"===verticalDirection&&isOverTopHalf)},_contactContainers:function(){this.options.protectRoot&&this.currentItem[0].parentNode===this.element[0]||$.ui.sortable.prototype._contactContainers.apply(this,arguments)},_clear:function(){var i,item;for($.ui.sortable.prototype._clear.apply(this,arguments),this._pid_current===this._uiHash().item.parent().parent().attr("id")&&this._sort_current===this._uiHash().item.index()||this._trigger("relocate",this._relocate_event,this._uiHash()),i=this.items.length-1;i>=0;i--)item=this.items[i].item[0],this._clearEmpty(item)},serialize:function(options){var o=$.extend({},this.options,options),items=this._getItemsAsjQuery(o&&o.connected),str=[];return $(items).each(function(){var res=($(o.item||this).attr(o.attribute||"id")||"").match(o.expression||/(.+)[-=_](.+)/),pid=($(o.item||this).parent(o.listType).parent(o.items).attr(o.attribute||"id")||"").match(o.expression||/(.+)[-=_](.+)/);res&&str.push((o.key||res[1])+"["+(o.key&&o.expression?res[1]:res[2])+"]="+(pid?o.key&&o.expression?pid[1]:pid[2]:o.rootID))}),!str.length&&o.key&&str.push(o.key+"="),str.join("&")},toHierarchy:function(options){var o=$.extend({},this.options,options),ret=[];return $(this.element).children(o.items).each(function(){var level=function _recursiveItems(item){var currentItem,id=($(item).attr(o.attribute||"id")||"").match(o.expression||/(.+)[-=_](.+)/);var data=$(item).data();data.nestedSortableItem&&delete data.nestedSortableItem;if(id)return currentItem={id:id[2]},currentItem=$.extend({},currentItem,data),$(item).children(o.listType).children(o.items).length>0&&(currentItem.children=[],$(item).children(o.listType).children(o.items).each(function(){var level=_recursiveItems(this);currentItem.children.push(level)})),currentItem}(this);ret.push(level)}),ret},toArray:function(options){var o=$.extend({},this.options,options),sDepth=o.startDepthCount||0,ret=[],left=1;return o.excludeRoot||(ret.push({item_id:o.rootID,parent_id:null,depth:sDepth,left,right:2*($(o.items,this.element).length+1)}),left++),$(this.element).children(o.items).each(function(){left=function _recursiveArray(item,depth,_left){var id,pid,parentItem,right=_left+1;$(item).children(o.listType).children(o.items).length>0&&(depth++,$(item).children(o.listType).children(o.items).each(function(){right=_recursiveArray($(this),depth,right)}),depth--);id=($(item).attr(o.attribute||"id")||"").match(o.expression||/(.+)[-=_](.+)/);depth===sDepth?pid=o.rootID:(parentItem=$(item).parent(o.listType).parent(o.items).attr(o.attribute||"id").match(o.expression||/(.+)[-=_](.+)/),pid=parentItem[2]);if(id){var data=$(item).children("div").data(),itemObj=$.extend(data,{id:id[2],parent_id:pid,depth,left:_left,right});ret.push(itemObj)}_left=right+1;return _left}(this,sDepth,left)}),ret=ret.sort(function(a,b){return a.left-b.left})},_clearEmpty:function(item){var elem,search,replace,o=this.options,childrenList=$(item).children(o.listType),hasChildren=childrenList.has("li").length,doNotClear=o.doNotClear||hasChildren||o.protectRoot&&$(item)[0]===this.element[0];o.isTree&&(elem=item,search=o.branchClass,replace=o.leafClass,doNotClear&&(search=[replace,replace=search][0]),$(elem).removeClass(search).addClass(replace)),doNotClear||(childrenList.parent().removeClass(o.expandedClass),childrenList.remove())},_getLevel:function(item){var list,level=1;if(this.options.listType)for(list=item.closest(this.options.listType);list&&list.length>0&&!list.is(".ui-sortable");)level++,list=list.parent().closest(this.options.listType);return level},_getChildLevels:function(parent,depth){var self=this,o=this.options,result=0;return depth=depth||0,$(parent).children(o.listType).children(o.items).each(function(index,child){result=Math.max(self._getChildLevels(child,depth+1),result)}),depth?result+1:result},_isAllowed:function(parentItem,level,levels){var o=this.options,maxLevels=this.placeholder.closest(".ui-sortable").nestedSortable("option","maxLevels"),oldParent=this.currentItem.parent().parent();o.disableParentChange&&(void 0!==parentItem&&!oldParent.is(parentItem)||void 0===parentItem&&oldParent.is("li"))||!o.isAllowed(this.placeholder,parentItem,this.currentItem)?(this.placeholder.addClass(o.errorClass),this.beyondMaxLevels=maxLevels<levels&&0!==maxLevels?levels-maxLevels:1):maxLevels<levels&&0!==maxLevels?(this.placeholder.addClass(o.errorClass),this.beyondMaxLevels=levels-maxLevels):(this.placeholder.removeClass(o.errorClass),this.beyondMaxLevels=0)}})),$.mjs.nestedSortable.prototype.options=$.extend({},$.ui.sortable.prototype.options,$.mjs.nestedSortable.prototype.options)});