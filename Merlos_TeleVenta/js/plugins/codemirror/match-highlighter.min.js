!function(mod){"object"==typeof exports&&"object"==typeof module?mod(require("../../lib/codemirror"),require("./matchesonscrollbar")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./matchesonscrollbar"],mod):mod(CodeMirror)}(function(CodeMirror){"use strict";var DEFAULT_MIN_CHARS=2,DEFAULT_TOKEN_STYLE="matchhighlight",DEFAULT_DELAY=100,DEFAULT_WORDS_ONLY=!1;function State(options){"object"==typeof options&&(this.minChars=options.minChars,this.style=options.style,this.showToken=options.showToken,this.delay=options.delay,this.wordsOnly=options.wordsOnly,this.annotateScrollbar=options.annotateScrollbar),null==this.style&&(this.style=DEFAULT_TOKEN_STYLE),null==this.minChars&&(this.minChars=DEFAULT_MIN_CHARS),null==this.delay&&(this.delay=DEFAULT_DELAY),null==this.wordsOnly&&(this.wordsOnly=DEFAULT_WORDS_ONLY),this.overlay=this.timeout=null,this.matchesonscroll=null}function cursorActivity(cm){var state=cm.state.matchHighlighter;clearTimeout(state.timeout),state.timeout=setTimeout(function(){highlightMatches(cm)},state.delay)}function addOverlay(cm,query,hasBoundary,style){var state=cm.state.matchHighlighter;if(cm.addOverlay(state.overlay=function(query,hasBoundary,style){return{token:function(stream){if(stream.match(query)&&(!hasBoundary||function(stream,re){return!(stream.start&&re.test(stream.string.charAt(stream.start-1))||stream.pos!=stream.string.length&&re.test(stream.string.charAt(stream.pos)))}(stream,hasBoundary)))return style;stream.next(),stream.skipTo(query.charAt(0))||stream.skipToEnd()}}}(query,hasBoundary,style)),state.annotateScrollbar){var searchFor=hasBoundary?new RegExp("\\b"+query+"\\b"):query;state.matchesonscroll=cm.showMatchesOnScrollbar(searchFor,!0,{className:"CodeMirror-selection-highlight-scrollbar"})}}function removeOverlay(cm){var state=cm.state.matchHighlighter;state.overlay&&(cm.removeOverlay(state.overlay),state.overlay=null,state.annotateScrollbar&&(state.matchesonscroll.clear(),state.matchesonscroll=null))}function highlightMatches(cm){cm.operation(function(){var state=cm.state.matchHighlighter;if(removeOverlay(cm),cm.somethingSelected()||!state.showToken){var from=cm.getCursor("from"),to=cm.getCursor("to");if(from.line==to.line&&(!state.wordsOnly||function(cm,from,to){if(null!==cm.getRange(from,to).match(/^\w+$/)){if(from.ch>0){var pos={line:from.line,ch:from.ch-1},chr=cm.getRange(pos,from);if(null===chr.match(/\W/))return!1}if(to.ch<cm.getLine(from.line).length){var pos={line:to.line,ch:to.ch+1},chr=cm.getRange(to,pos);if(null===chr.match(/\W/))return!1}return!0}return!1}(cm,from,to))){var selection=cm.getRange(from,to).replace(/^\s+|\s+$/g,"");selection.length>=state.minChars&&addOverlay(cm,selection,!1,state.style)}}else{for(var re=!0===state.showToken?/[\w$]/:state.showToken,cur=cm.getCursor(),line=cm.getLine(cur.line),start=cur.ch,end=start;start&&re.test(line.charAt(start-1));)--start;for(;end<line.length&&re.test(line.charAt(end));)++end;start<end&&addOverlay(cm,line.slice(start,end),re,state.style)}})}CodeMirror.defineOption("highlightSelectionMatches",!1,function(cm,val,old){old&&old!=CodeMirror.Init&&(removeOverlay(cm),clearTimeout(cm.state.matchHighlighter.timeout),cm.state.matchHighlighter=null,cm.off("cursorActivity",cursorActivity)),val&&(cm.state.matchHighlighter=new State(val),highlightMatches(cm),cm.on("cursorActivity",cursorActivity))})});